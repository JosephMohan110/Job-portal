<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title%}Settings - WorkNest{% endblock %}</title>
<style>
    :root {
        --primary: #4a6fff;
        --primary-light: #e8eeff;
        --primary-dark: #3a5fef;
        --secondary: #6c757d;
        --success: #28a745;
        --info: #17a2b8;
        --warning: #ffc107;
        --danger: #dc3545;
        --light: #f8f9fa;
        --dark: #343a40;
        --white: #ffffff;
        --gray: #6c757d;
        --gray-light: #e9ecef;
        --text-dark: #212529;
        --text-light: #6c757d;
        --border-color: #dee2e6;
        --shadow: rgba(0, 0, 0, 0.1);
        --shadow-lg: rgba(0, 0, 0, 0.15);
        --sidebar-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
        --sidebar-hover: rgba(74, 111, 255, 0.1);
        
        /* Settings-specific colors */
        --settings-primary: #8e44ad;
        --settings-primary-light: #f3e8fd;
        --settings-primary-dark: #7d3c98;
        --settings-secondary: #2c3e50;
        --settings-accent: #e74c3c;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background-color: #f5f7fb;
        color: var(--text-dark);
        line-height: 1.6;
    }

    /* Django Messages Display */
    .django-messages {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1002;
        max-width: 400px;
        width: 90%;
    }

    .django-alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform-origin: top right;
    }

    .django-alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        border-left: 4px solid #28a745;
    }

    .django-alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-left: 4px solid #dc3545;
    }

    .django-alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
        border-left: 4px solid #ffc107;
    }

    .django-alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
        border-left: 4px solid #17a2b8;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%) scale(0.9);
            opacity: 0;
        }
        to {
            transform: translateX(0) scale(1);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0) scale(1);
            opacity: 1;
        }
        to {
            transform: translateX(100%) scale(0.9);
            opacity: 0;
        }
    }

    .django-alert.hiding {
        animation: slideOut 0.3s ease forwards;
    }

    .django-alert .alert-icon {
        font-size: 1.2rem;
        min-width: 20px;
    }

    .django-alert .alert-content {
        flex: 1;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .django-alert .alert-close {
        background: none;
        border: none;
        color: inherit;
        cursor: pointer;
        font-size: 1rem;
        opacity: 0.7;
        transition: opacity 0.3s;
        padding: 0;
        margin-left: 10px;
    }

    .django-alert .alert-close:hover {
        opacity: 1;
    }

    /* Main Container */
    .main-container {
        min-height: 100vh;
        padding-top: 10px; 
        position: relative;
    }

    /* Page Header Section  */
    .page-header {
        margin-bottom: 1.5rem;
        padding: 0 2rem;
        margin-top: 0; 
    }

    .page-header h1 {
        font-size: 2rem; 
        color: var(--settings-primary);
        margin-bottom: 0.3rem; 
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .page-header h1 i {
        font-size: 1.6rem; 
    }

    .page-header p {
        color: var(--text-light);
        font-size: 1rem;
        max-width: 600px;
        margin-top: 0;
    }

    /* Settings Layout */
    .settings-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
        padding: 0 2rem 2rem;
        align-items: start;
    }

    /* Sticky Settings Sidebar */
    .settings-sidebar {
        background: var(--white);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 10px 20px var(--shadow);
        height: fit-content;
        position: sticky;
        top: 180px; 
        border: 1px solid var(--border-color);
        transition: top 0.3s ease;
    }

    .settings-sidebar h3 {
        color: var(--settings-primary);
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--settings-primary-light);
        font-size: 1.3rem;
    }

    .settings-nav {
        list-style: none;
    }

    .settings-nav li {
        margin-bottom: 0.5rem;
    }

    .settings-nav a {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        color: var(--text-dark);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .settings-nav a:hover, .settings-nav a.active {
        background: var(--settings-primary-light);
        color: var(--settings-primary);
    }

    .settings-nav i {
        margin-right: 15px;
        width: 20px;
        text-align: center;
        font-size: 1.2rem;
        color: var(--settings-primary);
    }

    /* Settings Content */
    .settings-content {
        background: var(--white);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 10px 20px var(--shadow);
        border: 1px solid var(--border-color);
        min-height: calc(100vh - 260px); 
    }

    .settings-section {
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        scroll-margin-top: 100px; 
    }

    .settings-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .settings-section h2 {
        color: var(--settings-primary);
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .settings-section h2 i {
        font-size: 1.3rem;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-dark);
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
        background: var(--white);
    }

    .form-control:focus {
        border-color: var(--settings-primary);
        box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.2);
        outline: none;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1rem;
    }

    .form-check input {
        width: 18px;
        height: 18px;
    }

    .form-check label {
        margin-bottom: 0;
        font-weight: normal;
    }

    /* Button Styles */
    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 5px 15px var(--shadow);
        background: var(--white);
        color: var(--text-dark);
        border: 1px solid var(--border-color);
    }

    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px var(--shadow);
        background: var(--settings-primary);
        color: var(--white);
    }

    .btn-primary {
        background: var(--settings-primary);
        color: var(--white);
    }

    .btn-danger {
        background: var(--danger);
        color: var(--white);
    }

    .btn-success {
        background: var(--success);
        color: var(--white);
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 0.9rem;
    }

    /* Privacy Options */
    .privacy-options {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .privacy-option {
        background: var(--light);
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
    }

    .privacy-option-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .privacy-option-title {
        font-weight: 600;
        color: var(--settings-primary);
    }

    .privacy-option-description {
        color: var(--text-light);
        font-size: 0.9rem;
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--gray-light);
        transition: .4s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: var(--white);
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: var(--settings-primary);
    }

    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    /* Security Alerts */
    .security-alerts {
        margin-top: 1.5rem;
    }

    .alert-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1rem;
        padding: 1rem;
        background: var(--light);
        border-radius: 8px;
        border-left: 4px solid var(--settings-primary);
    }

    .alert-item i {
        color: var(--settings-primary);
        font-size: 1.2rem;
    }

    .alert-content h4 {
        margin-bottom: 5px;
        font-size: 1rem;
    }

    .alert-content p {
        color: var(--text-light);
        font-size: 0.9rem;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1100;
        overflow-y: auto;
    }

    .modal.show {
        display: block;
    }

    .modal-dialog {
        max-width: 500px;
        margin: 1.75rem auto;
    }

    .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 3.5rem);
    }

    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        background-color: var(--white);
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        outline: 0;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem 1.5rem 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
        margin-bottom: 0;
        font-size: 1.3rem;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-body {
        position: relative;
        flex: 1 1 auto;
        padding: 1.5rem;
    }

    .modal-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        gap: 10px;
    }

    .close {
        float: right;
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
        color: var(--text-light);
        text-shadow: none;
        opacity: .5;
        background: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
    }

    .close:hover {
        opacity: 1;
        color: var(--settings-primary);
        transform: scale(1.1);
    }

    .text-warning {
        color: #ffc107 !important;
    }

    .text-muted {
        color: var(--text-light) !important;
        font-size: 0.9rem;
    }

    /* Pending Changes Indicator */
    .pending-changes {
        position: relative;
    }

    .pending-changes::after {
        content: '';
        position: absolute;
        top: -5px;
        right: -5px;
        width: 12px;
        height: 12px;
        background-color: var(--warning);
        border-radius: 50%;
        border: 2px solid var(--white);
        box-shadow: 0 0 0 2px var(--warning);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
    }

    /* Password field styling */
    .password-toggle {
        color: var(--text-light);
        transition: color 0.3s;
        cursor: pointer;
    }

    .password-toggle:hover {
        color: var(--settings-primary);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .settings-container {
            grid-template-columns: 250px 1fr;
        }
        
        .settings-sidebar {
            top: 100px;
        }
    }

    @media (max-width: 992px) {
        .main-container {
            padding-top: 80px;
        }
        
        .page-header, .settings-container {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        
        .settings-container {
            grid-template-columns: 1fr;
        }
        
        .settings-sidebar {
            position: static;
            margin-bottom: 1.5rem;
            top: auto;
        }
        
        .settings-section {
            scroll-margin-top: 80px;
        }
        
        .django-messages {
            top: 70px;
            right: 10px;
            left: 10px;
            max-width: none;
            width: auto;
        }
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .page-header h1 {
            font-size: 1.8rem;
        }
        
        .page-header {
            padding: 0 1rem;
        }
        
        .settings-container {
            padding: 0 1rem 2rem;
        }
        
        .settings-content {
            padding: 1.5rem;
        }
    }

    @media (max-width: 576px) {
        .main-container {
            padding-top: 70px;
        }
        
        .page-header, .settings-container {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .page-header h1 {
            font-size: 1.6rem;
        }
        
        .django-messages {
            top: 60px;
            right: 5px;
            left: 5px;
        }
        
        .django-alert {
            padding: 0.8rem 1rem;
            font-size: 0.9rem;
        }
    }

    /* Smooth scrolling */
    html {
        scroll-behavior: smooth;
    }
</style>
</head>
<body>

    <!-- Employer Header -->
    {% include 'employer_html/employer_header.html' %}

    <!-- Django Messages Display -->
    <div class="django-messages" id="djangoMessages">
        {% for message in messages %}
            <div class="django-alert django-alert-{{ message.tags }}" data-message-id="{{ forloop.counter }}">
                <div class="alert-icon">
                    <i class="fas 
                        {% if message.tags == 'error' %}fa-times-circle
                        {% elif message.tags == 'success' %}fa-check-circle
                        {% elif message.tags == 'warning' %}fa-exclamation-triangle
                        {% else %}fa-info-circle
                        {% endif %}"></i>
                </div>
                <div class="alert-content">{{ message }}</div>
                <button class="alert-close" onclick="removeMessage(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        {% endfor %}
    </div>

    <!-- Main Content Area -->
    <div class="main-container">
        <!-- Page Header - FIXED: Reduced spacing -->
        <div class="page-header">
            <h1><i class="fas fa-cog"></i> Account Settings</h1>
            <p>Manage your profile, payment methods, privacy settings, and more</p>
        </div>

        <!-- Settings Content -->
        <div class="settings-container">
            <!-- Settings Sidebar - STICKY -->
            <div class="settings-sidebar">
                <h3>Settings</h3>
                <ul class="settings-nav">
                    <li><a href="#profile" class="active"><i class="fas fa-user"></i> Profile</a></li>
                    <li><a href="#payment"><i class="fas fa-credit-card"></i> Payment Methods</a></li>
                    <li><a href="#privacy"><i class="fas fa-shield-alt"></i> Privacy & Security</a></li>
                    <li><a href="#location"><i class="fas fa-map-marker-alt"></i> Location</a></li>
                    <li><a href="#notifications"><i class="fas fa-bell"></i> Notifications</a></li>
                    <li><a href="#preferences"><i class="fas fa-sliders-h"></i> Preferences</a></li>
                    <li><a href="#billing"><i class="fas fa-file-invoice"></i> Billing History</a></li>
                </ul>
            </div>

            <!-- Settings Content -->
            <div class="settings-content">
                <!-- Profile Section -->
                <div class="settings-section" id="profile">
                    <h2><i class="fas fa-user"></i> Profile Information</h2>
                    <form method="POST" action="/employer/settings/update-profile/" enctype="multipart/form-data" id="profileForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="profilePhoto">Profile Photo</label>
                            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                                <!-- Profile Image Container -->
                                <div class="user-avatar pending-changes" style="width: 80px; height: 80px; position: relative;">
                                    <!-- Original image (hidden when pending removal) -->
                                    {% if employer.profile_image %}
                                        <img src="{{ employer.profile_image.url }}" alt="Current Profile Photo" 
                                            style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" 
                                            id="originalProfileImage">
                                    {% else %}
                                        <div style="width: 100%; height: 100%; background: var(--settings-primary-light); 
                                            display: flex; align-items: center; justify-content: center; border-radius: 8px;" 
                                            id="originalProfileImage">
                                            <i class="fas fa-user" style="font-size: 2rem; color: var(--settings-primary);"></i>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Preview image (for new uploads) -->
                                    <div id="previewImageContainer" style="display: none; width: 100%; height: 100%;">
                                        <img id="previewImage" src="" alt="New Profile Photo Preview" 
                                            style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                                    </div>
                                    
                                    <!-- Pending removal indicator -->
                                    <div id="pendingRemovalIndicator" style="display: none; position: absolute; top: -5px; right: -5px; 
                                         background: var(--warning); color: white; border-radius: 50%; width: 20px; height: 20px; 
                                         font-size: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-exclamation"></i>
                                    </div>
                                </div>
                                
                                <!-- Hidden file input -->
                                <input type="file" name="profile_image" id="profilePhoto" accept="image/*" style="display: none;">
                                
                                <!-- Action buttons -->
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <button type="button" class="btn btn-sm" id="uploadBtn" onclick="selectNewImage()">
                                        <i class="fas fa-upload"></i> Upload New Photo
                                    </button>
                                    
                                    <button type="button" class="btn btn-sm btn-danger" id="removeBtn" 
                                            onclick="showRemoveConfirmation()" 
                                            {% if not employer.profile_image %}disabled style="opacity: 0.6; cursor: not-allowed;"{% endif %}>
                                        <i class="fas fa-trash"></i> Remove Photo
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Status message -->
                            <div id="photoStatusMessage" style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none;"></div>
                            
                            <!-- Hidden fields to track image state -->
                            <input type="hidden" name="remove_photo" id="removePhotoFlag" value="0">
                            <input type="hidden" name="image_changed" id="imageChangedFlag" value="0">
                            <input type="hidden" name="pending_action" id="pendingAction" value="">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">First Name</label>
                                <input type="text" id="firstName" name="first_name" class="form-control" value="{{ employer.first_name }}">
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name</label>
                                <input type="text" id="lastName" name="last_name" class="form-control" value="{{ employer.last_name }}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" name="email" class="form-control" value="{{ employer.email }}" readonly>
                            <small style="color: var(--text-light);">Email cannot be changed</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" name="phone" class="form-control" value="{{ employer.phone }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="company">Company Name</label>
                            <input type="text" id="company" name="company_name" class="form-control" value="{{ employer.company_name|default_if_none:'' }}" placeholder="Enter your company name">
                        </div>
                        
                        <div class="form-group">
                            <label for="bio">Bio/Description</label>
                            <textarea id="bio" name="bio" class="form-control" rows="4" placeholder="Tell workers about yourself and your hiring needs">{{ employer.bio|default_if_none:'' }}</textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="saveChangesBtn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelChangesBtn" style="display: none; margin-left: 10px;" onclick="cancelPendingChanges()">
                            <i class="fas fa-times"></i> Cancel Changes
                        </button>
                    </form>
                </div>

                <!-- Location Section -->
                <div class="settings-section" id="location">
                    <h2><i class="fas fa-map-marker-alt"></i> Location Settings</h2>
                    <form method="POST" action="{% url 'update_location' %}">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address" name="address" class="form-control" value="{{ employer.address|default_if_none:'' }}" placeholder="Enter your street address">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" class="form-control" value="{{ employer.city|default_if_none:'' }}" placeholder="Enter your city">
                        </div>
                        <div class="form-group">
                            <label for="state">State/Province</label>
                            <input type="text" id="state" name="state" class="form-control" value="{{ employer.state|default_if_none:'' }}" placeholder="Enter your state">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="zipCode">ZIP/Postal Code</label>
                            <input type="text" id="zipCode" name="zip_code" class="form-control" value="{{ employer.zip_code|default_if_none:'' }}" placeholder="Enter your ZIP code">
                        </div>

                        <div class="form-group">
                            <label for="country">Country</label>
                            <select id="country" name="country" class="form-control">
                                <option value="">Select Country</option>
                                <option value="India" {% if employer.country == 'India' %}selected{% endif %}>India</option>
                                <option value="United States" {% if employer.country == 'United States' %}selected{% endif %}>United States</option>
                                <option value="United Kingdom" {% if employer.country == 'United Kingdom' %}selected{% endif %}>United Kingdom</option>
                                <option value="Canada" {% if employer.country == 'Canada' %}selected{% endif %}>Canada</option>
                                <option value="Australia" {% if employer.country == 'Australia' %}selected{% endif %}>Australia</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="locationVisibility">Location Visibility</label>
                        <select id="locationVisibility" name="location_visibility" class="form-control">
                            <option value="full" {% if employer.location_visibility == 'full' %}selected{% endif %}>Show full address to workers</option>
                            <option value="partial" {% if employer.location_visibility == 'partial' %}selected{% endif %}>Show only city and state to workers</option>
                            <option value="hidden" {% if employer.location_visibility == 'hidden' %}selected{% endif %}>Hide location from workers</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary"><i class="fas fa-save"></i> Save Location</button>
                    </form>
                </div>
                
                <!-- Notifications Section -->
                <div class="settings-section" id="notifications">
                    <h2><i class="fas fa-bell"></i> Notification Preferences</h2>
                    
                    <form method="POST" action="{% url 'update_notifications' %}">
                        {% csrf_token %}
                        
                        <div class="privacy-options">
                            <div class="privacy-option">
                                <div class="privacy-option-header">
                                    <div class="privacy-option-title">Email Notifications</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="email_notifications" {% if employer.email_notifications %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="privacy-option-description">
                                    Receive email notifications about new job applications, messages, and platform updates.
                                </div>
                            </div>
                            
                            <div class="privacy-option">
                                <div class="privacy-option-header">
                                    <div class="privacy-option-title">SMS Notifications</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="sms_notifications" {% if employer.sms_notifications %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="privacy-option-description">
                                    Receive text message alerts for urgent hiring requests and important updates.
                                </div>
                            </div>
                            <div class="privacy-option">
                                <div class="privacy-option-header">
                                    <div class="privacy-option-title">Push Notifications</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="push_notifications" {% if employer.push_notifications %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="privacy-option-description">
                                    Receive push notifications on your device for real-time updates.
                                </div>
                            </div>
                            
                            <div class="privacy-option">
                                <div class="privacy-option-header">
                                    <div class="privacy-option-title">Marketing Communications</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="marketing_communications" {% if employer.marketing_communications %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="privacy-option-description">
                                    Receive emails about new features, promotions, and tips for hiring workers.
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem;"><i class="fas fa-save"></i> Save Notification Settings</button>
                    </form>
                </div>
                
                <!-- Preferences Section -->
                <div class="settings-section" id="preferences">
                    <h2><i class="fas fa-sliders-h"></i> Account Preferences</h2>
                    
                    <form method="POST" action="{% url 'update_preferences' %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="language">Language</label>
                            <select id="language" name="language" class="form-control">
                                <option value="english" {% if employer.language == 'english' %}selected{% endif %}>English</option>
                                <option value="hindi" {% if employer.language == 'hindi' %}selected{% endif %}>Hindi</option>
                                <option value="spanish" {% if employer.language == 'spanish' %}selected{% endif %}>Spanish</option>
                                <option value="french" {% if employer.language == 'french' %}selected{% endif %}>French</option>
                                <option value="german" {% if employer.language == 'german' %}selected{% endif %}>German</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="currency">Currency</label>
                            <select id="currency" name="currency" class="form-control">
                                <option value="inr" {% if employer.currency == 'inr' %}selected{% endif %}>Indian Rupee (₹)</option>
                                <option value="usd" {% if employer.currency == 'usd' %}selected{% endif %}>US Dollar ($)</option>
                                <option value="eur" {% if employer.currency == 'eur' %}selected{% endif %}>Euro (€)</option>
                                <option value="gbp" {% if employer.currency == 'gbp' %}selected{% endif %}>British Pound (£)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="timezone">Timezone</label>
                            <select id="timezone" name="timezone" class="form-control">
                                <option value="ist" {% if employer.timezone == 'ist' %}selected{% endif %}>India Standard Time (IST)</option>
                                <option value="est" {% if employer.timezone == 'est' %}selected{% endif %}>Eastern Standard Time (EST)</option>
                                <option value="pst" {% if employer.timezone == 'pst' %}selected{% endif %}>Pacific Standard Time (PST)</option>
                                <option value="gmt" {% if employer.timezone == 'gmt' %}selected{% endif %}>Greenwich Mean Time (GMT)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateFormat">Date Format</label>
                            <select id="dateFormat" name="date_format" class="form-control">
                                <option value="dd-mm-yyyy" {% if employer.date_format == 'dd-mm-yyyy' %}selected{% endif %}>DD-MM-YYYY</option>
                                <option value="mm-dd-yyyy" {% if employer.date_format == 'mm-dd-yyyy' %}selected{% endif %}>MM-DD-YYYY</option>
                                <option value="yyyy-mm-dd" {% if employer.date_format == 'yyyy-mm-dd' %}selected{% endif %}>YYYY-MM-DD</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Preferences</button>
                    </form>
                </div>

                <!-- Payment section-->
                {% include 'employer_html/employer_payment_setting.html' %}

                <!-- Privacy & Security Section -->
                <div class="settings-section" id="privacy">
                    <h2><i class="fas fa-shield-alt"></i> Privacy & Security</h2>
                    <form method="POST" action="{% url 'update_privacy_security' %}">
                        {% csrf_token %}
                        <div class="privacy-options">
                            <div class="privacy-option">
                                <div class="privacy-option-header">
                                    <div class="privacy-option-title">Two-Factor Authentication</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="two_factor_auth" {% if employer.two_factor_auth %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="privacy-option-description">
                                    Add an extra layer of security to your account by requiring a verification code in addition to your password.
                                </div>
                            </div>
                            <div class="privacy-option">
                                <div class="privacy-option-header">
                                    <div class="privacy-option-title">Show Profile to Workers</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="show_profile_to_workers" {% if employer.show_profile_to_workers %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="privacy-option-description">
                                    Allow workers to view your profile information and hiring history.
                                </div>
                            </div>
                            <div class="privacy-option">
                                <div class="privacy-option-header">
                                    <div class="privacy-option-title">Data Sharing for Analytics</div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="data_sharing_analytics" {% if employer.data_sharing_analytics %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="privacy-option-description">
                                    Help us improve our services by sharing anonymous usage data.
                                </div>
                            </div>
                        </div>

                        <div class="security-alerts">
                            <h3 style="margin-bottom: 1rem;">Security Alerts</h3>
                            <div class="alert-item">
                                <i class="fas fa-shield-alt"></i>
                                <div class="alert-content">
                                    <h4>Last Password Change</h4>
                                    <p>Your password was last changed {{ employer.last_password_change|date:"F d, Y"|default:"Never" }}</p>
                                </div>
                            </div>
                            <div class="alert-item">
                                <i class="fas fa-desktop"></i>
                                <div class="alert-content">
                                    <h4>Active Sessions</h4>
                                    <p>2 devices are currently logged into your account</p>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 2rem;">
                            <button type="button" class="btn" data-toggle="modal" data-target="#changePasswordModal">
                                <i class="fas fa-key"></i> Change Password
                            </button> 

                            <button type="button" class="btn btn-danger" style="margin-left: 10px;" data-toggle="modal" data-target="#deactivateModal">
                                <i class="fas fa-user-slash"></i> Deactivate Account
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Billing History Section -->
                <div class="settings-section" id="billing">
                    <h2><i class="fas fa-file-invoice"></i> Billing History</h2>
                    <p>View and download your past invoices and receipts</p>
                    
                    <div style="background: var(--light); border-radius: 8px; padding: 1.5rem; margin-top: 1.5rem;">
                        <p style="text-align: center; color: var(--text-light);">No billing history available yet.</p>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <button class="btn"><i class="fas fa-download"></i> Download All Invoices</button>
                        <button class="btn" style="margin-left: 10px;"><i class="fas fa-envelope"></i> Email Billing Summary</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Deactivate Account Modal -->
    <div class="modal fade" id="deactivateModal" tabindex="-1" role="dialog" aria-labelledby="deactivateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deactivateModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning"></i> Deactivate Account
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div id="deactivateError" class="alert alert-danger" style="display: none; margin: 15px 15px 0 15px; padding: 10px; border-radius: 8px;"></div>
                
                <form method="POST" action="{% url 'deactivate_account' %}" id="deactivateForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p><strong>Warning:</strong> This action will immediately deactivate your account.</p>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i>
                            <strong>What happens when you deactivate:</strong>
                            <ul style="margin-top: 10px; margin-bottom: 0; padding-left: 20px;">
                                <li>Your account will be immediately deactivated</li>
                                <li>You won't be able to log in</li>
                                <li>Your profile will not be visible to workers</li>
                                <li>Active job postings will be paused</li>
                                <li>Admin can restore your account if needed</li>
                            </ul>
                        </div>
                        
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="deactivatePassword">Enter Password to Confirm</label>
                            <div style="position: relative;">
                                <input type="password" id="deactivatePassword" name="password" class="form-control" 
                                       required placeholder="Enter your current password">
                                <span class="password-toggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                            <small class="text-muted">For security, please enter your current password to confirm deactivation.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger" id="deactivateSubmitBtn">
                            <i class="fas fa-user-slash"></i> Deactivate Account
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Remove Photo Modal -->
    <div class="modal fade" id="removePhotoModal" tabindex="-1" role="dialog" aria-labelledby="removePhotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removePhotoModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning"></i> Remove Profile Photo
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to remove your profile photo?</p>
                    <p class="text-muted">This will mark the photo for removal. Click "Save Changes" to apply this change.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Keep Photo</button>
                    <button type="button" class="btn btn-danger" id="confirmRemovePhoto">
                        <i class="fas fa-trash"></i> Mark for Removal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Upload Modal -->
    <div class="modal fade" id="cancelUploadModal" tabindex="-1" role="dialog" aria-labelledby="cancelUploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelUploadModalLabel">
                        <i class="fas fa-question-circle text-info"></i> Cancel Photo Upload
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to cancel this photo upload?</p>
                    <p class="text-muted">The new photo will be discarded and the previous photo will be shown.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Continue Upload</button>
                    <button type="button" class="btn btn-primary" id="confirmCancelUpload">
                        <i class="fas fa-times"></i> Cancel Upload
                    </button>
                </div>
            </div>
        </div>
    </div>                  

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="fas fa-key text-primary"></i> Change Password
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div id="passwordError" class="alert alert-danger" style="display: none; margin: 15px 15px 0 15px; padding: 10px; border-radius: 8px;"></div>
                
                <form method="POST" action="{% url 'change_password' %}" id="passwordChangeForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="current_password">Current Password</label>
                            <div style="position: relative;">
                                <input type="password" id="current_password" name="current_password" class="form-control" 
                                       required placeholder="Enter your current password">
                                <span class="password-toggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                            <small class="text-muted">Enter your current password to verify your identity.</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="new_password">New Password</label>
                            <div style="position: relative;">
                                <input type="password" id="new_password" name="new_password" class="form-control" 
                                       required placeholder="Enter your new password">
                                <span class="password-toggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                            <small class="text-muted">
                                Password must be at least 8 characters long and contain one uppercase, one lowercase, one number, and one special character.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm_password">Confirm New Password</label>
                            <div style="position: relative;">
                                <input type="password" id="confirm_password" name="confirm_password" class="form-control" 
                                       required placeholder="Confirm your new password">
                                <span class="password-toggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                            <small class="text-muted">Re-enter your new password to confirm.</small>
                        </div>
                        
                        </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="submitPasswordBtn">
                            <i class="fas fa-save"></i> Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="modal fade" style="display: none;">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Alert</h5>
                    <button type="button" class="close" onclick="closeCustomAlert()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="customAlertBody">
                    <!-- Content will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="closeCustomAlert()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables for Profile Photo
        let selectedFile = null;
        let hasExistingImage = {% if employer.profile_image %} true {% else %}false{% endif %};
        let pendingAction = ''; // 'remove' or 'upload'
        
        // Django Messages Auto-hide Functionality
        function autoHideMessages() {
            const messages = document.querySelectorAll('.django-alert');
            messages.forEach(message => {
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (message.parentElement) {
                        message.classList.add('hiding');
                        setTimeout(() => {
                            if (message.parentElement) {
                                message.remove();
                            }
                        }, 300);
                    }
                }, 5000);
            });
        }
        
        // Remove message function
        function removeMessage(button) {
            const message = button.closest('.django-alert');
            if (message) {
                message.classList.add('hiding');
                setTimeout(() => {
                    if (message.parentElement) {
                        message.remove();
                    }
                }, 300);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. Initialization and Setup ---
            setupButtonListeners();
            setupModalListeners();
            
            // --- 2. Auto-hide Django Messages ---
            autoHideMessages();
            
            // --- 3. Auto-Show Password Modal on Error ---
            const openPasswordModalFlag = "{{ open_password_modal }}";
            if (openPasswordModalFlag === 'True') {
                showModal('changePasswordModal');
                
                // Move Django error message to the modal's internal alert area
                const djangoErrorAlert = document.querySelector('.alert-danger');
                if (djangoErrorAlert) {
                    const modalErrorDiv = document.getElementById('passwordError');
                    if (modalErrorDiv) {
                        modalErrorDiv.innerHTML = djangoErrorAlert.innerHTML;
                        modalErrorDiv.style.display = 'block';
                        djangoErrorAlert.style.display = 'none'; // Hide the main page alert
                    }
                }
            }
            
            // --- 4. Password Toggle Functionality ---
            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const input = this.parentElement.querySelector('input');
                    const icon = this.querySelector('i');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        input.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            });

            // --- 5. Password Form Submission Handler ---
            const passwordForm = document.getElementById('passwordChangeForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', function(e) {
                    const submitBtn = document.getElementById('submitPasswordBtn');
                    
                    // Disable submit button and show spinner while waiting for server response
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
                    }
                    // Allow form to submit normally
                });
            }
            
            // --- 6. Form submission handler for profile changes ---
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    // Set the hidden fields based on pending action
                    if (pendingAction === 'remove') {
                        document.getElementById('removePhotoFlag').value = '1';
                        document.getElementById('imageChangedFlag').value = '1';
                        document.getElementById('pendingAction').value = 'remove';
                    } else if (pendingAction === 'upload' && selectedFile) {
                        document.getElementById('removePhotoFlag').value = '0';
                        document.getElementById('imageChangedFlag').value = '1';
                        document.getElementById('pendingAction').value = 'upload';
                    } else {
                        document.getElementById('removePhotoFlag').value = '0';
                        document.getElementById('imageChangedFlag').value = '0';
                        document.getElementById('pendingAction').value = '';
                    }
                    
                    // If no image change was made, clear the file input to avoid empty file submission
                    if (pendingAction !== 'upload') {
                        document.getElementById('profilePhoto').value = '';
                    }
                });
            }

            // --- 7. Settings Navigation Active State ---
            const settingsNavItems = document.querySelectorAll('.settings-nav a');
            const settingsSections = document.querySelectorAll('.settings-section');
            
            // Function to update active navigation item based on scroll position
            function updateActiveNav() {
                let currentSectionId = '';
                
                // Find which section is currently in view
                settingsSections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    if (rect.top <= 150 && rect.bottom >= 150) {
                        currentSectionId = section.id;
                    }
                });
                
                // Update active class on navigation items
                settingsNavItems.forEach(item => {
                    const href = item.getAttribute('href');
                    if (href === `#${currentSectionId}`) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            // Click event for settings navigation
            settingsNavItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all items
                    settingsNavItems.forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Scroll to the corresponding section
                    const targetId = this.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);
                    
                    if (targetSection) {
                        // Calculate offset for sticky header
                        const headerHeight = 90; // Adjusted based on new padding-top
                        const targetPosition = targetSection.offsetTop - headerHeight - 10;
                        
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });
            
            // Update active nav on scroll
            window.addEventListener('scroll', updateActiveNav);
            
            // Initial call to set active nav
            updateActiveNav();
        });

        // --- Profile Photo Management Functions ---
        
        function setupButtonListeners() {
            // Remove button
            const removeBtn = document.getElementById('removeBtn');
            if (removeBtn) {
                removeBtn.addEventListener('click', showRemoveConfirmation);
            }
            
            // Upload button
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', selectNewImage);
            }
        }
        
        function setupModalListeners() {
            // Confirm remove photo button
            const confirmRemoveBtn = document.getElementById('confirmRemovePhoto');
            if (confirmRemoveBtn) {
                confirmRemoveBtn.addEventListener('click', markPhotoForRemoval);
            }
            
            // Confirm cancel upload button
            const confirmCancelBtn = document.getElementById('confirmCancelUpload');
            if (confirmCancelBtn) {
                confirmCancelBtn.addEventListener('click', cancelImageUpload);
            }
            
            // Setup close buttons
            document.querySelectorAll('.close, .btn-secondary[data-dismiss="modal"]').forEach(button => {
                button.addEventListener('click', handleCloseModal);
            });

            // Setup modal open buttons
            document.querySelectorAll('[data-toggle="modal"]').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('data-target').replace('#', '');
                    showModal(targetId);
                });
            });
        }
        
        function showRemoveConfirmation() {
            if (!hasExistingImage || pendingAction === 'remove') {
                return;
            }
            showModal('removePhotoModal');
        }
        
        function markPhotoForRemoval() {
            // Show pending removal indicator
            document.getElementById('pendingRemovalIndicator').style.display = 'flex';
            
            // Show original image with reduced opacity
            const originalImage = document.getElementById('originalProfileImage');
            originalImage.style.opacity = '0.5';
            originalImage.style.filter = 'grayscale(50%)';
            
            // Hide preview if it exists
            document.getElementById('previewImageContainer').style.display = 'none';
            
            // Update status message
            showStatusMessage('Photo marked for removal. Click "Save Changes" to apply.', 'warning');
            
            // Update pending action
            pendingAction = 'remove';
            
            // Update UI state
            updateUIState();
            
            // Hide modal
            hideModal('removePhotoModal');
        }
        
        function selectNewImage() {
            document.getElementById('profilePhoto').click();
        }
        
        // When user selects a new image
        document.getElementById('profilePhoto').addEventListener('change', function(event) {
            if (this.files && this.files[0]) {
                selectedFile = this.files[0];
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Show preview
                    document.getElementById('previewImageContainer').style.display = 'block';
                    document.getElementById('previewImage').src = e.target.result;
                    
                    // Hide original image
                    document.getElementById('originalProfileImage').style.display = 'none';
                    
                    // Hide pending removal indicator if it was shown
                    document.getElementById('pendingRemovalIndicator').style.display = 'none';
                    
                    // Update status message
                    showStatusMessage('New photo selected. Click "Save Changes" to apply.', 'info');
                    
                    // Update pending action
                    pendingAction = 'upload';
                    
                    // Update UI state
                    updateUIState();
                };
                reader.readAsDataURL(selectedFile);
            }
        });
        
        function cancelImageUpload() {
            // Hide preview
            document.getElementById('previewImageContainer').style.display = 'none';
            
            // Show original image
            document.getElementById('originalProfileImage').style.display = 'block';
            document.getElementById('originalProfileImage').style.opacity = '1';
            document.getElementById('originalProfileImage').style.filter = 'none';
            
            // Clear file input
            document.getElementById('profilePhoto').value = '';
            
            // Clear selected file
            selectedFile = null;
            
            // Clear pending action
            pendingAction = '';
            
            // Hide status message
            hideStatusMessage();
            
            // Update UI state
            updateUIState();
            
            // Hide modal
            hideModal('cancelUploadModal');
        }
        
        function cancelPendingChanges() {
            // Reset everything to original state
            if (pendingAction === 'remove') {
                // Restore original image
                document.getElementById('originalProfileImage').style.opacity = '1';
                document.getElementById('originalProfileImage').style.filter = 'none';
                document.getElementById('pendingRemovalIndicator').style.display = 'none';
            } else if (pendingAction === 'upload') {
                // Hide preview and show original
                document.getElementById('previewImageContainer').style.display = 'none';
                document.getElementById('originalProfileImage').style.display = 'block';
                document.getElementById('profilePhoto').value = '';
                selectedFile = null;
            }
            
            // Clear pending action
            pendingAction = '';
            
            // Hide status message
            hideStatusMessage();
            
            // Update UI state
            updateUIState();
        }
        
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('photoStatusMessage');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Set color based on type
            if (type === 'warning') {
                statusDiv.style.backgroundColor = 'var(--warning)';
                statusDiv.style.color = 'var(--dark)';
                statusDiv.style.borderLeft = '4px solid var(--warning)';
            } else if (type === 'info') {
                statusDiv.style.backgroundColor = 'var(--info)';
                statusDiv.style.color = 'white';
                statusDiv.style.borderLeft = '4px solid var(--info)';
            } else if (type === 'success') {
                statusDiv.style.backgroundColor = 'var(--success)';
                statusDiv.style.color = 'white';
                statusDiv.style.borderLeft = '4px solid var(--success)';
            }
        }
        
        function hideStatusMessage() {
            document.getElementById('photoStatusMessage').style.display = 'none';
        }
        
        function updateUIState() {
            const saveBtn = document.getElementById('saveChangesBtn');
            const cancelBtn = document.getElementById('cancelChangesBtn');
            
            if (pendingAction !== '') {
                // Show that there are pending changes
                document.querySelector('.user-avatar').classList.add('pending-changes');
                cancelBtn.style.display = 'inline-flex';
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            } else {
                // No pending changes
                document.querySelector('.user-avatar').classList.remove('pending-changes');
                cancelBtn.style.display = 'none';
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }
        
        function handleCloseModal() {
            const modal = this.closest('.modal');
            if (modal) {
                hideModal(modal.id);
            }
        }
        
        // --- Custom Alert/Modal Functions ---
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Apply show classes/styles for custom modals
                modal.classList.add('show');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                // Prevent scrolling on body
                if (modalId === 'changePasswordModal') {
                    // Ensure only one error message is visible
                    document.getElementById('passwordError').style.display = 'none';
                }
            }
        }
        
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Remove show classes/styles
                modal.classList.remove('show');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling

                // Reset forms and states for specific modals
                if (modalId === 'changePasswordModal') {
                    document.getElementById('passwordChangeForm').reset();
                    document.getElementById('passwordError').style.display = 'none';
                    
                    // Reset eye icons
                    document.querySelectorAll('.password-toggle i').forEach(icon => {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    });
                    
                    // Reset input types to password
                    document.querySelectorAll('#passwordChangeForm input[type="text"]').forEach(input => {
                        if (input.id.includes('password')) {
                            input.type = 'password';
                        }
                    });
                    
                    // Reset submit button text
                    const submitBtn = document.getElementById('submitPasswordBtn');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> Change Password';
                    }
                }
            }
        }

        function showCustomAlert(message) {
            const alertBody = document.getElementById('customAlertBody');
            if (alertBody) {
                alertBody.innerHTML = `<p>${message}</p>`;
            }
            showModal('customAlertModal');
        }
        
        function closeCustomAlert() {
            hideModal('customAlertModal');
        }

        // Deactivation modal password toggle
        const deactivatePasswordToggle = document.querySelector('#deactivatePassword + .password-toggle');
        if (deactivatePasswordToggle) {
            deactivatePasswordToggle.addEventListener('click', function() {
                const input = this.parentElement.querySelector('input');
                const icon = this.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        }

        // Deactivation form submission handler
        const deactivateForm = document.getElementById('deactivateForm');
        if (deactivateForm) {
            deactivateForm.addEventListener('submit', function(e) {
                const submitBtn = document.getElementById('deactivateSubmitBtn');
                
                // Disable button and show loading
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deactivating...';
                }
            });
        }
    </script>
</body>
</html>